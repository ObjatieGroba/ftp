# HW3

### Сборка

```
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j `nproc`
```

### Запуск сервера

```
./build/server 127.0.0.1 8080
```

`--help` - помощь

Сервер в папке работы создаёт два файла - текущее состояние доски и текущие состояния пользователей


### Запуск клиента


```
./build/client 127.0.0.1 8080
```

`--help` - помощь

Клиент требует для работы обычный debian terminal с поддержкой кодов `\033`


### Описание задачи

Реализовать сервис, который позволяет хранить распределенную доску надписей размера 10 на 25

Пользователи сервиса могу не чаще чем раз в минуту делать следующее:

1) Проголосовать за бан пользователя по логину

2) Заменить один любой символ на доске на какой-то из unix printable (не считая символов `\n` и `\r`)

Также необходимо сделать администратора и возможность просмотра списка текущих участников

Администратор может в любой момент совершать любые операции, в том числе блокировка и разблокировка пользователей


### Протокол

Используется простой текстовый протокол поверх TCP

Каждая команда записывается в отдельной строке (завершается символом `\n`)

Сервер с клиентами обмениваются только командами (ответ клиенту от сервера это тоже команда)

Используется метод асинхронной работы. То есть на переданную команду сервер не обязан отвечать моменталььно. Не на все команды обязательно отвечать.

##### Клиен -> Cервер

| Метод | Описание |
|-------|----------|
| `exit`  | Завершает сессию клиента |
| `get board` | Запрашивает у сервера передачу всей доски |
| `get users` | Запрашивает у сервера передачу всех активных пользователей |
| `login <user> <pass>` | Авторизует клиента в рамках этой сессии |
| `reg <user> <pass>` | Регистрирует пользователя |
| `capcha <result>` | Отвечает серверу на запрос ввода капчи |
| `vote <user>` | Голосует за бан пользователя по имени |
| `subscribe` | Подписываю текущую сессию на посылку изменений доски и активных пользователей |
| `unsubscribe` | Отписывает от подписки на изменения |
| `set <i> <j> <c>` | Запрашивает изменения символа в позиции `(i,j)` на символ `c` |

##### Администратор -> Cервер

Администратор также является и Клиентом, поэтому поддерживает все его методы

| Метод | Описание |
|-------|----------|
| `ban <user>` | Банит пользователя по имени |
| `unban <user>` | Разбанит пользователя по имени |
| `stop server` | Завершает работу сервера |

##### Сервер -> Клиент

| Метод | Описание |
|-------|----------|
| `Ok` | Успешная какая-либо операция |
| `capcha: <msg>` | Сервер запрашивает ввод капчи |
| `board: <data>` | Сервер отпвравляет полное текущее состояние доски. `<data>` представляет из себя строку из всех 250 символов доски |
| `users: <users>` | Сервер отправляет текущий список пользователей. `<users>` представляет из себя список имен пользователей разделенных пробелом |
| `<any>` | Если не удовлетворяет ни одному из других шаблонов - сообщение об ошибке  |

##### Сервер -> Клиент (только при подписке)

| Метод | Описание |
|-------|----------|
| `set <i> <j> <c>` | Сообщает об изменении символа в позиции `(i,j)` на символ `c` |
| `login <user>` | Сообщает об авторизации пользователя |
| `logout <user>` | Сообщает об деавторизации пользователя |

##### Примечания

Имя пользователя и пароль не могут содержать пробельных символов или символов не являющихся printable

##### Пример 0: Авторизация и выход

```
С: login user pass
S: Ok
C: exit
S: Bie
-- End of connection --
```

##### Пример 1: Неправильная регистрация пользователя (уже существует)

```
С: reg user apss
S: User already exists
```

##### Пример 2: Неправилльный ответ на капчу

```
S: capcha: Please write answer of 83 + 86 with capcha command
C: capcha 10
S: Bad capcha
```

##### Пример 3: Правильная регистрация пользователя

```
C: reg user pass
S: capcha: Please write answer of 93 + 35 with capcha command
C: capcha 148
S: Ok
```

##### Пример 4: Получение текущих пользователей

```
C: get users
S: users: admin anonymous
```

##### Пример 3: События по подписке

| Who | Command | Описание |
|----|----|----|
| Client | `subsribe` | Запрос подписки |
| Server | `Ok` | Успешно |
| Server | `set 1 1 x` | Событие 1 |
| Server | `set 2 3 _` | Событие 2 |
| Server | `login admin` | Событие 3 |
| Server | `set 3 4 a` | Событие 4 |
| Client | `unsubsctibe` | Запрос Конца подписки |
| Server | `logout someuser` | Потому что еще не исполнилась команда (асинхронность наше всё) |
| Server | `Ok` | Успешно отказ от подписки |

### Реализация сервера

Сервер полностью поддерживает протокол

Сервер поддерживает работу со многими клиентами

Запросы каждого клиента по отдельности выполняются по принципу FIFO

Сервер запрашивает капчу только при вызове метода регистрации. При этом если следующим сообщением не получен ответ на капчу, то регистрация считается не успешной, а также разрывается соединение с клиентом

Капча представвляет из себя человекочитаемую строку с ясным ответом

Ограничение длины имени пользователя - 10 символов

Консоль сервера также является полноценным клиентом к серверу. При запуске в консоли уже выполнен вход в пользователя admin

Без авторизации пользователь считается анонимным

Предопределены два пользовалеля: `anonymous` и `admin` (пароль `admin`)

Если хотя бы двое проголосовали за бан пользователя, то все его активные сессии (у которых активна подписка) получают предупреждение

Если хотя бы половина + 1 от количества зарегистрировавшихся пользователей проголосовали за бан, то пользователь становится забаненым

Голоса считаются уникально по пользователю (нельзя проголосовать за кого-то дважды)

Реализована возможность перелогиниться в рамках той же сессии

Возможно перелогиниться от анонима - достаточно ввести в качестве логина и пароля anonymous

На протяжении всей работы сервер пишет в stderr логи

### Реализация клиента

Асинхронный клиент полностью поддерживает протокол

Клиент является консольным (ширина консоли должна быть не менее 70 символов, а высота не менее 15 строк)

В начале работы клиент оформляет подписку на события, запрашивает текущее состояние пользователей и доски

Клиент в фоновом режиме обновляет состояние доски

Клиент поддерживает все команды ровно в виде метода протокола. Достаточно вписать команду и нажать enter.

Клиент показывает список текущих участников сбоку от поля (не более 9ти)
